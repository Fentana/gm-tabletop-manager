<!doctype html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta charset="utf-8">
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta content="width=device-width, initial-scale=1" name="viewport">
	<meta content="Shapies Tabletop RPG Manager" name="description">
	<meta content="Almighty Nassar" name="author">
	<link rel="icon" href="favicon.ico">
	<title>Monster Creator</title>
	<!-- CSS SCRIPTS -->
	<link rel="stylesheet" type="text/css" href="../css/bootstrap.css" media="all">
	<link rel="stylesheet" type="text/css" href="../css/bootstrap-theme.css" media="all">
	<link rel="stylesheet" type="text/css" href="../css/form.css" media="all">
</head>
<body>
	<div class="container">
		<div class="row">
			<div class="col-md-12 well">
				<h2>Monster Creator</h2>
				<p><strong>Disclaimer:</strong> <em>This Monster Creator is inspired by D&amp;D 5th Edition, but should not be considered compatible with that edition. The terms used in the creator have come from the Pathfinder SRD. The mechanics and assumptions used by this Creator do not follow the specifications provided in the core materials. Use this Creator at your own discretion, and please double check the final figures.</em></p>
				<h4>Notes</h4>
				<ul>
					<li>Averages of a dice roll: 1d4 = 2.5; 1d6 = 3.5; 1d8 = 4.5; 1d10 = 5.5; 1d12 = 6.5; 1d20 = 10.5</li>
					<li>JavaScript is required to be enabled for the Creator to run adequately</li>
					<li>The Creator was designed to be stand-alone and does not require third-party scripts or server-side processing (You can save this page onto your desktop and still use it)</li>
					<li>Saved monsters (and all other data) can only be accessed from the machine used to create it. To open it on another machine you will need to export the data file</li>
				</ul>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<div id="form" class="form form-inline">
					<div class="form-group">
						<p class="control-label">Name</p>
						<input type="text" name="name" id="name" value="Bandit" class="form-control col-sm-2">
					</div>
					<div class="form-group">
						<p class="control-label">Type</p>
						<div id="formType"></div>
					</div>
					<div class="form-group">
						<p class="control-label">Alignment</p>
						<select id="alignment" class="form-control" name="alignment">
							<option value="Lawful-Good">Lawful-Good</option>
							<option value="Good">Good</option>
							<option value="Chaotic-Good">Chaotic-Good</option>
							<option value="Lawful">Lawful</option>
							<option value="Neutral" selected>Neutral</option>
							<option value="Chaotic">Chaotic</option>
							<option value="Lawful-Evil">Lawful-Evil</option>
							<option value="Evil">Evil</option>
							<option value="Chaotic-Evil">Chaotic-Evil</option>
						</select>
					</div>
					<div class="form-group">
						<p class="control-label">Speed (ft)</p>
						<input type="number" name="speed" id="speed" value="30" class="form-control">
					</div>
					<hr />
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<div id="form" class="form form-inline">
					<div class="form-group">
						<p class="control-label">Size</p>
						<div id="formSize"></div>
					</div>
					<div class="form-group">
						<p class="control-label">Number of Hit Die</p>
						<input type="number" name="hit_die" id="hit_die" value="5" class="form-control">
					</div>
					<div class="form-group">
						<p class="control-label">HP Bonus</p>
						<input type="number" name="hit_bonus" id="hit_bonus" value="0" class="form-control">
					</div>
				</div>
				<p><em>The Hit Die is determined by the size of the monster; "HP Bonus" is the extra amount of HP you want to add</em></p>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">				
				<div id="form" class="form form-inline">
					<div class="form-group">
						<p class="control-label">STR (<span id="str_mod">0</span>)</p>
						<input type="number" name="str" id="str" value="10" class="form-control" style="width:8em;">
					</div>
					<div class="form-group">
						<p class="control-label">DEX (<span id="dex_mod">0</span>)</p>
						<input type="number" name="dex" id="dex" value="10" class="form-control" style="width:8em;">
					</div>
					<div class="form-group">
						<p class="control-label">CON (<span id="con_mod">0</span>)</p>
						<input type="number" name="con" id="con" value="10" class="form-control" style="width:8em;">
					</div>
					<div class="form-group">
						<p class="control-label">INT (<span id="int_mod">0</span>)</p>	
						<input type="number" name="int" id="int" value="10" class="form-control" style="width:8em;">
					</div>
					<div class="form-group">
						<p class="control-label">WIS (<span id="wis_mod">0</span>)</p>
						<input type="number" name="wis" id="wis" value="10" class="form-control" style="width:8em;">
					</div>
					<div class="form-group">
						<p class="control-label">CHA (<span id="cha_mod">0</span>)</p>
						<input type="number" name="cha" id="cha" value="10" class="form-control" style="width:8em;">
					</div>
				</div>
				<p><em>The following is the standard attribute array: 8,10,12,13,14,15</em></p>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<h4>Saving Throws</h4>
				<div class="form form-inline">
					<div class="form-group">
						<label><input type="checkbox" name="saveStr" id="saveStr" value="Yes" class="form-control"> STR save?</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" name="saveDex" id="saveDex" value="Yes" class="form-control"> DEX save?</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" name="saveCon" id="saveCon" value="Yes" class="form-control"> CON save?</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" name="saveInt" id="saveInt" value="Yes" class="form-control"> WIS save?</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" name="saveWis" id="saveWis" value="Yes" class="form-control"> INT save?</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" name="saveCha" id="saveCha" value="Yes" class="form-control"> CHA save?</label>
					</div>
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<div class="form form-inline">
					<div class="form-group">
						<p class="control-label">Armour Type</p>
						<div id="formArmour"></div>
					</div>
					<div class="form-group">
						<p class="control-label">Armour Bonus</p>
						<input type="number" name="armour_bonus" id="armour_bonus" value="0" class="form-control">
					</div>
					<div class="form-group">
						<p class="control-label">AC Bonus</p>
						<input type="number" name="ac_bonus" id="ac_bonus" value="0" class="form-control">
					</div>
					<div class="form-group">
						<label><input type="checkbox" name="shielded" id="shielded" value="Yes" class="form-control"> Shielded?</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" name="addDex" id="addDex" value="Yes" class="form-control"> Add Dex Mod?</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" name="addCon" id="addCon" value="Yes" class="form-control"> Add Con Mod?</label>
					</div>
				</div>
				<p><em>"Armour Type" just sets a useful descriptor. Every other option affects the final AC</em></p>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<div id="TraitForm" class="form form-inline">
					<h4>Traits</h4>
					<p><a href='#' class='btn btn-primary hidden' id="addTrait">Add</a></p>
					<div class="form-group">
						<input type="text" id="trait_name_1" name="trait_name_1" class="form-control trait_name" placeholder="Name" />
						<textarea rows="2" id="trait_detail_1" name="trait_detail_1" class="form-control trait_detail" placeholder="Details"></textarea>
						<a href="#" class="btn btn-danger removeInput hidden"> Remove</a>
					</div>
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<div id="AttackForm" class="form form-inline">
					<h4>Attacks</h4>
					<p><em>The following Proficiency, Attack Bonus and Save DC are all based off the Defensive CR. Feel free to adjust these when writing up your attacks.</em></p>
					<p>Proficiency: <span id='prof' class="label label-info">2</span></p>
					<p>STR Attack: <span id='str_atk' class="label label-info">2</span>; DEX Attack: <span id='dex_atk' class="label label-info">2</span>; CON Attack: <span id='con_atk' class="label label-info">2</span>; INT Attack: <span id='int_atk' class="label label-info">2</span>; WIS Attack: <span id='wis_atk' class="label label-info">2</span>; CHA Attack: <span id='cha_atk' class="label label-info">2</span></p>
					<p>STR save: <span id='str_save' class="label label-info">10</span>; DEX save: <span id='dex_save' class="label label-info">10</span>; CON save: <span id='con_save' class="label label-info">10</span>; INT save: <span id='int_save' class="label label-info">10</span>; WIS save: <span id='wis_save' class="label label-info">10</span>; CHA save: <span id='cha_save' class="label label-info">10</span></p>
					<p><a href='#' class='btn btn-primary hidden' id="addAttack">Add</a></p>
					<div class="form-group">
						<input type="text" id="attack_name_1" name="attack_name_1" class="form-control attack_name" placeholder="Name" />
						<textarea rows="2" id="attack_detail_1" name="attack_detail_1" class="form-control attack_detail" placeholder="Details"></textarea>
						<a href="#" class="btn btn-danger removeInput hidden"> Remove</a>
					</div>
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<div id="ReactionForm" class="form form-inline">
					<h4>Reactions</h4>
					<p><a href='#' class='btn btn-primary hidden' id="addReaction">Add</a></p>
					<div class="form-group">
						<input type="text" id="reaction_name_1" name="reaction_name_1" class="form-control reaction_name" placeholder="Name" />
						<textarea rows="2" id="reaction_detail_1" name="reaction_detail_1" class="form-control reaction_detail" placeholder="Details"></textarea>
						<a href="#" class="btn btn-danger removeInput hidden"> Remove</a>
					</div>
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<p class="control-label"><strong>Damage Resistances</strong></p>
				<div id="resist" class="form form-inline">
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<p class="control-label"><strong>Damage Immunities</strong></p>
				<div id="immune" class="form form-inline">
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<p class="control-label"><strong>Condition Immunities</strong></p>
				<div id="condition" class="form form-inline">
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<div class="form form-inline">
					<div class="form-group checkbox">
						<p class="control-label"><strong>Senses</strong></p>
						<label><input type="radio" name="sense" id="sense" value="Normal" class="form-control" checked>Normal</label>
						<label><input type="radio" name="sense" id="sense" value="Darkvision" class="form-control">Darkvision</label>
						<label><input type="radio" name="sense" id="sense" value="Truesight" class="form-control">Truesight</label>
						<label><input type="radio" name="sense" id="sense" value="Blindsight" class="form-control">Blindsight</label>
						<label><input type="radio" name="sense" id="sense" value="Tremorsense" class="form-control" >Tremorsense</label>
					</div>
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<p class="control-label"><strong>Languages</strong></p>
				<div id="language" class="form form-inline">
				</div>
				<hr/>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<h4>Adjustments</h4>
				<p><em>Your Offensive CR needs to be manually calculated since it is nearly impossible to create a system that will accept all forms of attack. Enter in the average Damage output for the first three rounds, the Attack Bonus or Save DC, and any effective adjustments to HP and AC as called for by special traits or abilities. Note that effective bonuses to damage and attack should be directly entered here.</em></p>
				<div id="form" class="form form-inline">
					<div class="form-group">
						<p class="control-label">Effective HP Bonus</p>
						<input type="number" name="effective_hp_bonus" id="effective_hp_bonus" value="0" class="form-control" >
					</div>
					<div class="form-group">
						<p class="control-label">Effective AC Bonus</p>
						<input type="number" name="effective_ac_bonus" id="effective_ac_bonus" value="0" class="form-control">
					</div>
					<div class="form-group">
						<p class="control-label">Attack Bonus / Save DC</p>
						<input type="number" name="offense_bonus" id="offense_bonus" value="0" class="form-control">
					</div>
					<div class="form-group">
						<p class="control-label">Attack Type</p>
						<select id="attack_type" class="form-control" name="attack_type">
							<option value="attack">Attack Bonus</option>
							<option value="save">Save DC</option>
						</select>
					</div>
				</div>
				<br />
				<div id="form" class="form form-inline">
					<div class="form-group">
						<p class="control-label">Round 1 Damage</p>
						<input type="number" name="rnd_1_dmg" id="rnd_1_dmg" value="0" class="form-control">
					</div>
					<div class="form-group">
						<p class="control-label">Round 2 Damage</p>
						<input type="number" name="rnd_2_dmg" id="rnd_2_dmg" value="0" class="form-control">
					</div>
					<div class="form-group">
						<p class="control-label">Round 3 Damage</p>
						<input type="number" name="rnd_3_dmg" id="rnd_3_dmg" value="0" class="form-control">
					</div>
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<div class="form form-inline">
					<div class="form-group well">
						<label class="control-label">Hit Points</label>
						<p><span id="hit_points">22</span> (<span id="hp_dice">5d8+0</span>)</p>
					</div>
					<div class="form-group well">
						<label class="control-label">Effective Hit Points</label>
						<p><span id="effective_hit_points">22</span></p>
					</div>
					<div class="form-group well">
						<label class="control-label">Armour Class</label>
						<p id="armour_class">10</p>
					</div>
					<div class="form-group well">
						<label class="control-label">Effective Armour Class</label>
						<p id="effective_armour_class">10</p>
					</div>
					<div class="form-group well">
						<label class="control-label">Defensive CR</label>
						<p id="defence_cr">1/8</p>
					</div>
					<div class="form-group well">
						<label class="control-label">Offensive CR</label>
						<p id="offensive_cr">0</p>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<div class="form form-inline">	
					<div class="form-group well">
						<label class="control-label">CR</label>
						<p id="cr">0</p>
					</div>
					<div class="form-group well">
						<label class="control-label">Proficiency</label>
						<p id="final_prof">0</p>
					</div>
					<div class="form-group well">
						<label class="control-label">Saving Throws</label>
						<p id="saves"></p>
					</div>
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">	
				<p><button class="btn btn-success" onclick='create();'>Submit</button></p>
				<hr />
			</div>
		</div>
		<div id="CanvasResult"></div>
	</div>
</body>
<script src="../js/jquery.js"></script>
<script src="../js/bootstrap.js"></script>
<script src="../js/html2canvas.js"></script>
<script src="../js/monsterStatBlock.js"></script>
<script src="../js/d20.js"></script>
<script src="../js/dice.js"></script>
<script>
	// Load up our d20 object and populate our form
	d20.load();
	$('#language').html(d20.makeCheckbox(d20.getLanguage(),'language'));
	$('#condition').html(d20.makeCheckbox(d20.getCondition(),'condition'));
	$('#immune').html(d20.makeCheckbox(d20.getDamage(),'immune'));
	$('#resist').html(d20.makeCheckbox(d20.getDamage(),'resist'));
	$('#formType').html(d20.makeSelect(d20.getOrigin(),'type','Humanoid'));
	$('#formSize').html(d20.makeSelect(d20.getSize(),'size','Medium'));
	$('#formArmour').html(d20.makeSelect(d20.getArmourStyle(),'size','None'));
	//Easy reference to our div
	var attackDiv = $('#AttackForm');
	var traitDiv = $('#TraitForm');
	var reactionDiv = $('#ReactionForm');
	// If Javascript is enabled, then remove our hidden option
	$('#addAttack, #addTrait, #addReaction, .removeInput').removeClass('hidden');
	// Add Attack form line
	$('#addAttack').on('click', function() {
	    var i = $('#AttackForm .form-group').size() + 1;
	    $('<div class="form-group">\
	       	<input id="attack_name_'+i+'" class="form-control attack_name" type="text" placeholder="Name" name="attack_name_'+i+'"> \
	    	<textarea id="attack_detail_'+i+'" class="form-control attack_detail" placeholder="Details" name="attack_detail_'+i+'"></textarea> \
	    	<a class="btn btn-danger removeInput" href="#"> Remove</a>').appendTo(attackDiv);
	    return false;
	});
	// Add Trait form line
	$('#addTrait').on('click', function() {
	    var i = $('#TraitForm .form-group').size() + 1;
	    $('<div class="form-group">\
	       	<input id="trait_name_'+i+'" class="form-control trait_name" type="text" placeholder="Name" name="trait_name_'+i+'"> \
	    	<textarea id="trait_detail_'+i+'" class="form-control trait_detail" placeholder="Details" name="trait_detail_'+i+'"></textarea> \
	    	<a class="btn btn-danger removeInput" href="#"> Remove</a>').appendTo(traitDiv);
	    return false;
	});
	// Add Reaction form line
	$('#addReaction').on('click', function() {
	    var i = $('#ReactionForm .form-group').size() + 1;
	    $('<div class="form-group">\
	       	<input id="reaction_name_'+i+'" class="form-control reaction_name" type="text" placeholder="Name" name="reaction_name_'+i+'"> \
	    	<textarea id="reaction_detail_'+i+'" class="form-control reaction_detail" placeholder="Details" name="reaction_detail_'+i+'"></textarea> \
	    	<a class="btn btn-danger removeInput" href="#"> Remove</a>').appendTo(reactionDiv);
	    return false;
	});
	// When a remove button is clicked, delete the owning div and renumber everything
	$('#AttackForm').on('click', '.removeInput', function() { 
	    $(this).parent('.form-group').remove();
	    var i = 1;
	    $('#AttackForm .form-group .attack_name').each(function() {
	        this.id='attack_name_'+i;
	        this.name='attack_name_'+i;
	        i++;
	    });
	    var i = 1;
	    $('#AttackForm .form-group .attack_detail').each(function() {
	        this.id='attack_detail_'+i;
	        this.name='attack_detail_'+i;
	        i++;
	    });
	    return false;
	});
	$('#TraitForm').on('click', '.removeInput', function() { 
	    $(this).parent('.form-group').remove();
	    var i = 1;
	    $('#TraitForm .form-group .trait_name').each(function() {
	        this.id='trait_name_'+i;
	        this.name='trait_name_'+i;
	        i++;
	    });
	    var i = 1;
	    $('#TraitForm .form-group .trait_detail').each(function() {
	        this.id='trait_detail_'+i;
	        this.name='trait_detail_'+i;
	        i++;
	    });
	    return false;
	});
	$('#ReactionForm').on('click', '.removeInput', function() { 
	    $(this).parent('.form-group').remove();
	    var i = 1;
	    $('#ReactionForm .form-group .reaction_name').each(function() {
	        this.id='reaction_name_'+i;
	        this.name='reaction_name_'+i;
	        i++;
	    });
	    var i = 1;
	    $('#ReactionForm .form-group .reaction_detail').each(function() {
	        this.id='reaction_detail_'+i;
	        this.name='reaction_detail_'+i;
	        i++;
	    });
	    return false;
	});
	// Calculate HP
	function calcHP() {
		var size = $('#size')[0].selectedIndex;
		var avg = (size < 5) ? 2.5+size : 5.5+size;
		// Raw values
		var mod = parseInt($('#con_mod').html());
		var dice = parseInt($('#hit_die').val());
		var bonus = parseInt($('#hit_bonus').val());
		var hp = Math.floor((dice * avg) + (dice * mod) + bonus);
		// Display the values
		$('#hit_points').html(hp+'');
		$('#hp_dice').html(dice+'d'+((avg-0.5)*2)+'+'+((dice*mod)+bonus));
		calcDCR();
	}
	// Calculate AC
	function calcAC() {
		// Raw values
		var armour = parseInt($('#armour_bonus').val());
		var bonus = parseInt($('#ac_bonus').val());
		var dexMod = ($("#addDex:checked" ).length > 0) ? parseInt($('#dex_mod').html()) : 0;
		var conMod = ($("#addCon:checked" ).length > 0) ? parseInt($('#con_mod').html()) : 0;
		var shield = ($("#shielded:checked" ).length > 0) ? 2 : 0;
		var ac = Math.floor(10 + armour + dexMod + conMod + shield + bonus);
		// Display the values
		$('#armour_class').html(ac+'');
		calcDCR();
	}
	// Calculate Defensive CR from given values
	function rawDCR(hp,ac) {
		ac = parseInt(ac,10);
		hp = parseInt(hp,10);
		var cr = 0;
		// Calculate CR
		if (hp > 805) {
			cr = 30 - (((19-ac)/2)|0);
		} else if (hp > 760) {
			cr = 29 - (((19-ac)/2)|0);
		} else if (hp > 715) {
			cr = 28 - (((19-ac)/2)|0);
		} else if (hp > 670) {
			cr = 27 - (((19-ac)/2)|0);
		} else if (hp > 625) {
			cr = 26 - (((19-ac)/2)|0);
		} else if (hp > 580) {
			cr = 25 - (((19-ac)/2)|0);
		} else if (hp > 535) {
			cr = 24 - (((19-ac)/2)|0);
		} else if (hp > 490) {
			cr = 23 - (((19-ac)/2)|0);
		} else if (hp > 445) {
			cr = 22 - (((19-ac)/2)|0);
		} else if (hp > 400) {
			cr = 21 - (((19-ac)/2)|0);
		} else if (hp > 355) {
			cr = 20 - (((19-ac)/2)|0);
		} else if (hp > 340) {
			cr = 19 - (((19-ac)/2)|0);
		} else if (hp > 325) {
			cr = 18 - (((19-ac)/2)|0);
		} else if (hp > 310) {
			cr = 17 - (((19-ac)/2)|0);
		} else if (hp > 295) {
			cr = 16 - (((18-ac)/2)|0);
		} else if (hp > 280) {
			cr = 15 - (((18-ac)/2)|0);
		} else if (hp > 265) {
			cr = 14 - (((18-ac)/2)|0);
		} else if (hp > 250) {
			cr = 13 - (((18-ac)/2)|0);
		} else if (hp > 235) {
			cr = 12 - (((17-ac)/2)|0);
		} else if (hp > 220) {
			cr = 11 - (((17-ac)/2)|0);
		} else if (hp > 205) {
			cr = 10 - (((17-ac)/2)|0);
		} else if (hp > 190) {
			cr = 9 - (((16-ac)/2)|0);
		} else if (hp > 175) {
			cr = 8 - (((16-ac)/2)|0);
		} else if (hp > 160) {
			cr = 7 - (((15-ac)/2)|0);
		} else if (hp > 145) {
			cr = 6 - (((15-ac)/2)|0);
		} else if (hp > 130) {
			cr = 5 - (((15-ac)/2)|0);
		} else if (hp > 115) {
			cr = 4 - (((14-ac)/2)|0);
		} else if (hp > 100) {
			cr = 3 - (((13-ac)/2)|0);
		} else if (hp > 85) {
			cr = 2 - (((13-ac)/2)|0);
		} else if (hp > 70) {
			cr = 1 - (((13-ac)/2)|0);
		} else {
			cr = 0 - (((13-ac)/2)|0);
		}
		if (cr <= 0) {
			if (hp > 49) {
				cr = '1/2';
			} else if (hp > 35) {
				cr = '1/4';
			} else if (hp > 6) {
				cr = '1/8';
			} else {
				cr = 0
			}
		}
		return cr;
	}
	// Calculate raw Offensive CR
	function calcOCR() {
		var rnd1 = parseInt($('#rnd_1_dmg').val());
		var rnd2 = parseInt($('#rnd_2_dmg').val());
		var rnd3 = parseInt($('#rnd_3_dmg').val());
		var bonus = parseInt($('#offense_bonus').val());
		var result = (rnd1 + rnd2 + rnd3) / 3;
		var cr = 0;
		// Switch up
		if ($("#attack_type").val() === "attack") {
			// Calculate CR
			if (result > 302) {
				cr = 30 - (((14-bonus)/2)|0);
			} else if (result > 284) {
				cr = 29 - (((13-bonus)/2)|0);
			} else if (result > 266) {
				cr = 28 - (((13-bonus)/2)|0);
			} else if (result > 248) {
				cr = 27 - (((13-bonus)/2)|0);
			} else if (result > 230) {
				cr = 26 - (((12-bonus)/2)|0);
			} else if (result > 212) {
				cr = 25 - (((12-bonus)/2)|0);
			} else if (result > 194) {
				cr = 24 - (((12-bonus)/2)|0);
			} else if (result > 176) {
				cr = 23 - (((11-bonus)/2)|0);
			} else if (result > 158) {
				cr = 22 - (((11-bonus)/2)|0);
			} else if (result > 140) {
				cr = 21 - (((11-bonus)/2)|0);
			} else if (result > 122) {
				cr = 20 - (((10-bonus)/2)|0);
			} else if (result > 116) {
				cr = 19 - (((10-bonus)/2)|0);
			} else if (result > 110) {
				cr = 18 - (((10-bonus)/2)|0);
			} else if (result > 104) {
				cr = 17 - (((10-bonus)/2)|0);
			} else if (result > 98) {
				cr = 16 - (((9-bonus)/2)|0);
			} else if (result > 92) {
				cr = 15 - (((8-bonus)/2)|0);
			} else if (result > 86) {
				cr = 14 - (((8-bonus)/2)|0);
			} else if (result > 80) {
				cr = 13 - (((8-bonus)/2)|0);
			} else if (result > 74) {
				cr = 12 - (((8-bonus)/2)|0);
			} else if (result > 68) {
				cr = 11 - (((8-bonus)/2)|0);
			} else if (result > 62) {
				cr = 10 - (((7-bonus)/2)|0);
			} else if (result > 56) {
				cr = 9 - (((7-bonus)/2)|0);
			} else if (result > 50) {
				cr = 8 - (((7-bonus)/2)|0);
			} else if (result > 44) {
				cr = 7 - (((6-bonus)/2)|0);
			} else if (result > 38) {
				cr = 6 - (((6-bonus)/2)|0);
			} else if (result > 32) {
				cr = 5 - (((6-bonus)/2)|0);
			} else if (result > 26) {
				cr = 4 - (((5-bonus)/2)|0);
			} else if (result > 20) {
				cr = 3 - (((4-bonus)/2)|0);
			} else if (result > 14) {
				cr = 2 - (((3-bonus)/2)|0);
			} else if (result > 8) {
				cr = 1 - (((3-bonus)/2)|0);
			} else {
				cr = 0 - (((3-bonus)/2)|0);
			}
			if (cr <= 0) {
				if (result > 5) {
					cr = '1/2';
				} else if (result > 3) {
					cr = '1/4';
				} else if (result > 1) {
					cr = '1/8';
				} else {
					cr = 0
				}
			}
		} else {
			if (result > 302) {
				cr = 30 - (((23-bonus)/2)|0);
			} else if (result > 284) {
				cr = 29 - (((22-bonus)/2)|0);
			} else if (result > 266) {
				cr = 28 - (((22-bonus)/2)|0);
			} else if (result > 248) {
				cr = 27 - (((22-bonus)/2)|0);
			} else if (result > 230) {
				cr = 26 - (((21-bonus)/2)|0);
			} else if (result > 212) {
				cr = 25 - (((21-bonus)/2)|0);
			} else if (result > 194) {
				cr = 24 - (((21-bonus)/2)|0);
			} else if (result > 176) {
				cr = 23 - (((20-bonus)/2)|0);
			} else if (result > 158) {
				cr = 22 - (((20-bonus)/2)|0);
			} else if (result > 140) {
				cr = 21 - (((20-bonus)/2)|0);
			} else if (result > 122) {
				cr = 20 - (((19-bonus)/2)|0);
			} else if (result > 116) {
				cr = 19 - (((19-bonus)/2)|0);
			} else if (result > 110) {
				cr = 18 - (((19-bonus)/2)|0);
			} else if (result > 104) {
				cr = 17 - (((19-bonus)/2)|0);
			} else if (result > 98) {
				cr = 16 - (((18-bonus)/2)|0);
			} else if (result > 92) {
				cr = 15 - (((18-bonus)/2)|0);
			} else if (result > 86) {
				cr = 14 - (((18-bonus)/2)|0);
			} else if (result > 80) {
				cr = 13 - (((18-bonus)/2)|0);
			} else if (result > 74) {
				cr = 12 - (((17-bonus)/2)|0);
			} else if (result > 68) {
				cr = 11 - (((17-bonus)/2)|0);
			} else if (result > 62) {
				cr = 10 - (((16-bonus)/2)|0);
			} else if (result > 56) {
				cr = 9 - (((16-bonus)/2)|0);
			} else if (result > 50) {
				cr = 8 - (((16-bonus)/2)|0);
			} else if (result > 44) {
				cr = 7 - (((15-bonus)/2)|0);
			} else if (result > 38) {
				cr = 6 - (((15-bonus)/2)|0);
			} else if (result > 32) {
				cr = 5 - (((15-bonus)/2)|0);
			} else if (result > 26) {
				cr = 4 - (((14-bonus)/2)|0);
			} else if (result > 20) {
				cr = 3 - (((13-bonus)/2)|0);
			} else if (result > 14) {
				cr = 2 - (((13-bonus)/2)|0);
			} else if (result > 8) {
				cr = 1 - (((13-bonus)/2)|0);
			} else {
				cr = 0 - (((13-bonus)/2)|0);
			}
			if (cr <= 0) {
				if (result > 5) {
					cr = '1/2';
				} else if (result > 3) {
					cr = '1/4';
				} else if (result > 1) {
					cr = '1/8';
				} else {
					cr = 0
				}
			}
		}
		$('#offensive_cr').html(cr);
		calcCR();
	}
	// Calculate Defensive CR
	function calcDCR() {
		// Calculate a raw DCR
		var ac = parseInt($('#armour_class').html(),10);
		var hp = parseInt($('#hit_points').html(),10);
		var cr = rawDCR(hp,ac);
		var prof = 0;
		// Number of immunities
		var immunities = $('input[name="immune"]:checked').length;
		var resistances = $('input[name="resist"]:checked').length;
		// Our saves
		var strSave = ($('#saveStr:checked').length > 0);
		var dexSave = ($('#saveDex:checked').length > 0);
		var conSave = ($('#saveCon:checked').length > 0);
		var intSave = ($('#saveInt:checked').length > 0);
		var wisSave = ($('#saveWis:checked').length > 0);
		var chaSave = ($('#saveCha:checked').length > 0);
		// Our effective DCR values
		var effective_hp = hp;
		var effective_ac = ac;
		// Refine DCR based on immunities and resistances
		if (cr > 7 && immunities > 2) {
			effective_hp = hp*1.25;
		} else if (cr > 5 && (immunities > 2 || resistances > 4)) {
			effective_hp = hp*1.5;
		} else if ((immunities > 2 || resistances > 4)) {
			effective_hp = hp*2;
		}
		// Refine DCR based on Saving Throws
		var count = 0;
		if (strSave) {
			count += 1;
		}
		if (dexSave) {
			count += 1;
		}
		if (conSave) {
			count += 1;
		}
		if (intSave) {
			count += 1;
		}
		if (wisSave) {
			count += 1;
		}
		if (chaSave) {
			count += 1;
		}
		if (count > 4) {
			effective_ac += 4;
		} else if (count > 2) {
			effective_ac += 2;
		}
		// Calculate our actual DCR
		effective_hp += parseInt($('#effective_hp_bonus').val());
		effective_ac += parseInt($('#effective_ac_bonus').val());
		cr = rawDCR(effective_hp,effective_ac);
		switch (cr) {
		case 30:
		case 29:
			prof = 9;
			break;
		case 28:
		case 27:
		case 26:
		case 25:
			prof = 8;
			break;
		case 24:
		case 23:
		case 22:
		case 21:
			prof = 7;
			break;
		case 20:
		case 19:
		case 18:
		case 17:
			prof = 6;
			break;
		case 16:
		case 15:
		case 14:
		case 13:
			prof = 5;
			break;
		case 12:
		case 11:
		case 10:
		case 9:
			prof = 4;
			break;
		case 8:
		case 7:
		case 6:
		case 5:
			prof = 3;
			break;
		default:
			prof = 2;
			break;
		}
		$('#defence_cr').html(cr+'');
		// Effective scores
		$('#effective_hit_points').html(effective_hp);
		$('#effective_armour_class').html(effective_ac);
		// Attack Proficiencies
		$('#prof').html(prof);
		$('#str_atk').html(prof+parseInt($('#str_mod').html()));
		$('#dex_atk').html(prof+parseInt($('#dex_mod').html()));
		$('#con_atk').html(prof+parseInt($('#con_mod').html()));
		$('#int_atk').html(prof+parseInt($('#int_mod').html()));
		$('#wis_atk').html(prof+parseInt($('#wis_mod').html()));
		$('#cha_atk').html(prof+parseInt($('#cha_mod').html()));
		// Attack Proficiencies
		$('#str_save').html(8+prof+parseInt($('#str_mod').html()));
		$('#dex_save').html(8+prof+parseInt($('#dex_mod').html()));
		$('#con_save').html(8+prof+parseInt($('#con_mod').html()));
		$('#int_save').html(8+prof+parseInt($('#int_mod').html()));
		$('#wis_save').html(8+prof+parseInt($('#wis_mod').html()));
		$('#cha_save').html(8+prof+parseInt($('#cha_mod').html()));
		calcOCR();
	}
	// Calculate final CR
	function calcCR() {
		var dcr = eval($('#defence_cr').html());
		var ocr = eval($('#offensive_cr').html());
		var result = ((dcr + ocr) / 2);
		var prof = 0;
		// Our saves
		var strSave = ($('#saveStr:checked').length > 0);
		var dexSave = ($('#saveDex:checked').length > 0);
		var conSave = ($('#saveCon:checked').length > 0);
		var intSave = ($('#saveInt:checked').length > 0);
		var wisSave = ($('#saveWis:checked').length > 0);
		var chaSave = ($('#saveCha:checked').length > 0);
		if (result < 1) {
			if (result >= 0.5) {
				result = '1/2';
			} else if (result >= 0.25) {
				result = '1/4';
			} else if (result >= 0.125) {
				result = '1/8';
			} else {
				result = 0
			}
		} else {
			result = result|0;
		}
		switch (result) {
		case 30:
		case 29:
			prof = 9;
			break;
		case 28:
		case 27:
		case 26:
		case 25:
			prof = 8;
			break;
		case 24:
		case 23:
		case 22:
		case 21:
			prof = 7;
			break;
		case 20:
		case 19:
		case 18:
		case 17:
			prof = 6;
			break;
		case 16:
		case 15:
		case 14:
		case 13:
			prof = 5;
			break;
		case 12:
		case 11:
		case 10:
		case 9:
			prof = 4;
			break;
		case 8:
		case 7:
		case 6:
		case 5:
			prof = 3;
			break;
		default:
			prof = 2;
			break;
		}
		var text = "";
		if (strSave) {
			text += "STR "+ (prof+parseInt($('#str_mod').html())) + ";";
		}
		if (dexSave) {
			text += "DEX "+ (prof+parseInt($('#dex_mod').html())) + ";";
		}
		if (conSave) {
			text += "CON "+ (prof+parseInt($('#con_mod').html())) + ";";
		}
		if (intSave) {
			text += "INT "+ (prof+parseInt($('#int_mod').html())) + ";";
		}
		if (wisSave) {
			text += "WIS "+ (prof+parseInt($('#wis_mod').html())) + ";";
		}
		if (chaSave) {
			text += "CHA "+ (prof+parseInt($('#cha_mod').html())) + ";";
		}
		$('#cr').html(result);
		$('#final_prof').html(prof);
		$('#saves').html(text);
	    html2canvas(attackDiv, {
	        onrendered: function(canvas) {
	        	$('#CanvasResult').html(canvas);
	        }
	    });
	}
	// Attribute changes
	$("#str").change(function () { $('#str_mod').html(Math.floor(($("#str").val()-10)/2)); calcAC(); });
	$("#con").change(function () { $('#con_mod').html(Math.floor(($("#con").val()-10)/2)); calcHP(); calcAC(); });
	$("#dex").change(function () { $('#dex_mod').html(Math.floor(($("#dex").val()-10)/2)); calcAC(); });
	$("#int").change(function () { $('#int_mod').html(Math.floor(($("#int").val()-10)/2)); calcAC(); });
	$("#wis").change(function () { $('#wis_mod').html(Math.floor(($("#wis").val()-10)/2)); calcAC(); });
	$("#cha").change(function () { $('#cha_mod').html(Math.floor(($("#cha").val()-10)/2)); calcAC(); });
	// Size-changes
	$('#size').change(function () { calcHP(); });
	// HP changes
	$("#hit_die").change(function () { calcHP(); });
	$("#hit_bonus").change(function () { calcHP(); });
	$("input[name='resist']").on("click",function () { calcDCR(); });
	$("input[name='immune']").on("click",function () { calcDCR(); });
	$("#effective_hp_bonus").change(function () { calcDCR(); });
	$("#effective_ac_bonus").change(function () { calcDCR(); });
	// AC changes
	$('#ac_bonus').change(function () { calcAC(); });
	$('#shielded').on("click", function () { calcAC(); });
	$('#addDex').on("click", function () { calcAC(); });
	$('#addCon').on("click", function () { calcAC(); });
	$("#armour_bonus").change(function () { calcAC(); });
	$('#saveStr').on("click", function () { calcAC(); });
	$('#saveDex').on("click", function () { calcAC(); });
	$('#saveCon').on("click", function () { calcAC(); });
	$('#saveInt').on("click", function () { calcAC(); });
	$('#saveWis').on("click", function () { calcAC(); });
	$('#saveCha').on("click", function () { calcAC(); });
	// Offensive changes
	$('#offense_bonus').change( function () { calcAC(); });
	$('#rnd_1_dmg').change( function () { calcAC(); });
	$('#rnd_2_dmg').change( function () { calcAC(); });
	$('#rnd_3_dmg').change( function () { calcAC(); });
</script>
</html>
